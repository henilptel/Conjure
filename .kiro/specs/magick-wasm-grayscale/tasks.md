# Implementation Plan

- [x] 1. Initialize Next.js 14 project with WASM configuration
  - [x] 1.1 Create Next.js 14 project with App Router, TypeScript, and Tailwind CSS
    - Run `npx create-next-app@latest` with appropriate flags
    - Ensure `app/` directory structure is created
    - _Requirements: 1.1_
  - [x] 1.2 Install @dlemstra/magick-wasm package
    - Add the latest version of the package
    - _Requirements: 1.4_
  - [x] 1.3 Configure next.config.js with security headers
    - Add `Cross-Origin-Opener-Policy: same-origin` header
    - Add `Cross-Origin-Embedder-Policy: require-corp` header
    - Apply headers to all routes
    - _Requirements: 1.2, 1.3_

- [x] 2. Implement file upload and validation
  - [x] 2.1 Create file validation utility
    - Create `lib/validation.ts` with `validateImageFile` function
    - Accept PNG, JPEG, GIF, and WebP MIME types
    - Return validation result with error message if invalid
    - _Requirements: 2.3, 2.4_
  - [x] 2.2 Write property test for file validation
    - **Property 2: Non-Image File Rejection**
    - Generate random non-image MIME types and verify rejection
    - **Validates: Requirements 2.3**
  - [x] 2.3 Create ImageProcessor client component shell
    - Create `app/components/ImageProcessor.tsx` as a client component
    - Add file input that accepts image files
    - Implement file selection handler with validation
    - _Requirements: 2.1, 2.2_

- [ ] 3. Implement Magick.WASM initialization and image display
  - [ ] 3.1 Create Magick.WASM initialization utility
    - Create `lib/magick.ts` with initialization logic
    - Handle WASM loading and initialization
    - Export initialized ImageMagick instance
    - _Requirements: 3.1_
  - [ ] 3.2 Implement canvas rendering with aspect ratio preservation
    - Create `lib/canvas.ts` with dimension calculation utilities
    - Calculate scaled dimensions maintaining aspect ratio
    - Implement `renderImageToCanvas` function
    - _Requirements: 3.2, 3.3_
  - [ ] 3.3 Write property test for aspect ratio preservation
    - **Property 3: Aspect Ratio Preservation**
    - Generate random image dimensions and verify ratio is maintained
    - **Validates: Requirements 3.3**
  - [ ] 3.4 Integrate WASM initialization and canvas rendering into ImageProcessor
    - Initialize Magick.WASM when image is uploaded
    - Render uploaded image to canvas
    - Display loading state during initialization
    - _Requirements: 3.1, 3.2, 5.1_

- [ ] 4. Implement grayscale conversion
  - [ ] 4.1 Create grayscale conversion function
    - Add `convertToGrayscale` function in `lib/magick.ts`
    - Use Magick.WASM grayscale command
    - Return processed image data
    - _Requirements: 4.2_
  - [ ] 4.2 Add grayscale button and integrate conversion
    - Show "Make Grayscale" button when image is displayed
    - Call conversion function on click
    - Re-render converted image to canvas
    - _Requirements: 4.1, 4.3_

- [ ] 5. Implement loading states and error handling
  - [ ] 5.1 Add processing state management
    - Track `isProcessing` state in component
    - Disable controls during processing
    - Re-enable controls after completion
    - _Requirements: 5.2, 5.3_
  - [ ] 5.2 Write property test for control state
    - **Property 4: Control State Matches Processing State**
    - Generate random processing states and verify control disabled state
    - **Validates: Requirements 5.2, 5.3**
  - [ ] 5.3 Implement error display
    - Show error messages when errors occur
    - Handle WASM initialization failure
    - Handle grayscale conversion failure
    - Preserve original image on conversion failure
    - _Requirements: 3.4, 4.4, 4.5, 5.4_
  - [ ] 5.4 Write property test for error display
    - **Property 5: Error State Displays Message**
    - Generate random error states and verify message is shown
    - **Validates: Requirements 5.4**

- [ ] 6. Create main page and final integration
  - [ ] 6.1 Update app/page.tsx to use ImageProcessor
    - Import and render ImageProcessor component
    - Add basic page styling with Tailwind
    - _Requirements: 2.1_
  - [ ] 6.2 Add loading indicator component
    - Create visual loading indicator
    - Display during WASM initialization and processing
    - _Requirements: 4.4, 5.1_

- [ ] 7. Final checkpoint
  - Ensure all tests pass, ask the user if questions arise.
